@page "/challenges/edit"
@using Microsoft.EntityFrameworkCore
@using BestRecipes.Domain
@inject IDbContextFactory<BestRecipes.Data.BestRecipesContext> DbFactory
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

@* NO AUTHORIZATION ATTRIBUTE HERE - Accessible to everyone *@

<PageTitle>Edit @(Challenge?.Name ?? "Challenge")</PageTitle>

@if (Challenge is null)
{
    <div class="container mt-5 text-center">
        <div class="spinner-border text-warning" role="status"></div>
        <p class="mt-2">Fetching challenge...</p>
    </div>
}
else
{
    @* --- EDIT HERO --- *@
    <div class="edit-hero">
        <div class="container">
            <nav class="fd-breadcrumb">CHALLENGES / EDIT / @Challenge.Name?.ToUpper()</nav>
            <h1 class="fd-recipe-title">MODIFY CHALLENGE</h1>
        </div>
    </div>

    <div class="container mt-5 mb-5">
        <EditForm Model="Challenge" OnValidSubmit="UpdateChallenge" FormName="editChallenge">
            <DataAnnotationsValidator />

            @* Hidden ID field is usually handled by the model, but good to ensure tracking *@
            <input type="hidden" name="Challenge.Id" value="@Challenge.Id" />

            <div class="row g-5">
                @* --- LEFT COLUMN: MAIN CONTENT --- *@
                <div class="col-lg-8">
                    <div class="fd-form-section">
                        <h3 class="fd-section-header">CHALLENGE DETAILS</h3>

                        <div class="mb-4">
                            <label class="fd-label">NAME</label>
                            <InputText @bind-Value="Challenge.Name" class="form-control fd-input" placeholder="e.g. Summer Cook-off" />
                            <ValidationMessage For="() => Challenge.Name" class="text-danger" />
                        </div>

                        <div class="mb-4">
                            <label class="fd-label">DETAILS & RULES</label>
                            <InputTextArea @bind-Value="Challenge.Details" class="form-control fd-input" rows="8" placeholder="Enter challenge details..." />
                            <ValidationMessage For="() => Challenge.Details" class="text-danger" />
                        </div>
                    </div>
                </div>

                @* --- RIGHT COLUMN: METADATA & SIDEBAR --- *@
                <div class="col-lg-4">
                    <div class="fd-sidebar-box shadow-sm">
                        <h4 class="fd-label mb-3 text-center">TIMELINE & SETTINGS</h4>

                        <div class="mb-3">
                            <label class="small fw-bold">START DATE</label>
                            <InputDate @bind-Value="Challenge.StartDate" class="form-control" />
                            <ValidationMessage For="() => Challenge.StartDate" class="text-danger" />
                        </div>

                        <div class="mb-3">
                            <label class="small fw-bold">END DATE</label>
                            <InputDate @bind-Value="Challenge.EndDate" class="form-control" />
                            <ValidationMessage For="() => Challenge.EndDate" class="text-danger" />
                        </div>

                        <hr />

                        @* We display these as Read-Only or "Hidden" if you don't want users changing history manually.
                           Using bg-light to indicate they are system fields.
                        *@
                        <div class="mb-3">
                            <label class="small fw-bold">CREATED BY</label>
                            <InputText @bind-Value="Challenge.CreatedBy" class="form-control bg-light" readonly />
                        </div>

                        <div class="mb-3">
                            <label class="small fw-bold">DATE CREATED</label>
                            <InputDate @bind-Value="Challenge.DateCreated" class="form-control bg-light" readonly />
                        </div>

                        @* Hidden inputs to ensure these values are passed back if needed, or just kept bound above *@
                        <div class="d-none">
                            <InputText @bind-Value="Challenge.UpdatedBy" />
                            <InputDate @bind-Value="Challenge.DateUpdated" />
                        </div>

                        <hr />

                        <div class="d-grid gap-2">
                            <button type="submit" class="fd-btn-save">SAVE CHANGES</button>
                            <a href="/challenges" class="btn btn-outline-secondary btn-sm">CANCEL</a>
                        </div>
                    </div>
                </div>
            </div>
        </EditForm>
    </div>
}

<style>
    /* STYLING MATCHING THE RECIPE PAGE */
    .edit-hero {
        background: #f8f9fa;
        padding: 40px 0;
        border-bottom: 4px solid var(--fd-black);
    }

    .fd-form-section {
        background: white;
        padding: 20px;
        border: 1px solid #eee;
    }

    .fd-sidebar-box {
        background: white;
        padding: 20px;
        border: 1px solid #eee;
    }

    .fd-section-header {
        font-weight: 900;
        font-size: 1.5rem;
        margin-bottom: 20px;
        text-transform: uppercase;
        letter-spacing: -1px;
    }

    .fd-label {
        font-family: 'Arial Black', sans-serif;
        font-size: 0.75rem;
        letter-spacing: 1.5px;
        color: var(--fd-grey);
        display: block;
        margin-bottom: 8px;
        text-transform: uppercase;
    }

    .fd-recipe-title {
        font-family: 'Arial Black', Gadget, sans-serif;
        font-weight: 900;
        letter-spacing: -2px;
        font-size: 3rem;
        margin: 0;
    }

    .fd-breadcrumb {
        font-size: 0.8rem;
        font-weight: bold;
        letter-spacing: 2px;
        color: #777;
        margin-bottom: 10px;
    }

    .fd-input {
        border: 2px solid #eee;
        border-radius: 0;
        padding: 12px;
        font-weight: 500;
    }

        .fd-input:focus {
            border-color: var(--fd-yellow);
            box-shadow: none;
        }

    .fd-btn-save {
        background: var(--fd-black);
        color: white;
        border: none;
        padding: 12px;
        font-weight: 900;
        letter-spacing: 1px;
        transition: 0.3s;
        text-transform: uppercase;
    }

        .fd-btn-save:hover {
            background: #444;
            transform: translateY(-2px);
        }

    :root {
        --fd-yellow: #F5EB3B;
        --fd-black: #222222;
        --fd-grey: #757575;
    }
</style>

@code {
    [SupplyParameterFromQuery]
    private int Id { get; set; }

    [SupplyParameterFromForm]
    private Challenge? Challenge { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // NO AUTH CHECK HERE
        if (Challenge is null)
        {
            using var context = DbFactory.CreateDbContext();
            Challenge = await context.Challenge.FirstOrDefaultAsync(m => m.Id == Id);

            if (Challenge is null)
            {
                NavigationManager.NavigateTo("notfound");
            }
        }
    }

    private async Task UpdateChallenge()
    {
        if (Challenge is null) return;

        using var context = DbFactory.CreateDbContext();

        // Ensure tracking is maintained
        context.Attach(Challenge).State = EntityState.Modified;

        try
        {
            await context.SaveChangesAsync();
            NavigationManager.NavigateTo("/challenges");
        }
        catch (DbUpdateConcurrencyException)
        {
            if (!ChallengeExists(Challenge.Id))
            {
                NavigationManager.NavigateTo("notfound");
            }
            else
            {
                throw;
            }
        }
    }

    private bool ChallengeExists(int id)
    {
        using var context = DbFactory.CreateDbContext();
        return context.Challenge.Any(e => e.Id == id);
    }
}