@page "/challenges/delete"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using BestRecipes.Domain
@inject IDbContextFactory<BestRecipes.Data.BestRecipesContext> DbFactory
@inject NavigationManager NavigationManager

@* 1. SECURITY LOCK: Only Admins can see this page *@
@attribute [Authorize(Roles = "Administrator")]

<PageTitle>Delete Challenge</PageTitle>

<div class="container mt-4">
    <h1 class="fd-section-title text-start text-danger">DELETE CHALLENGE</h1>
    <hr style="border: 2px solid var(--fd-black); opacity: 1;" />

    @if (challenge is null)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-warning" role="status"></div>
            <p class="mt-2">Locating challenge...</p>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-md-8">
                @* Warning Alert *@
                <div class="alert alert-warning border-dark rounded-0 shadow-sm mb-4">
                    <h4 class="fw-bold"><i class="bi bi-exclamation-triangle"></i> Are you sure?</h4>
                    <p class="mb-0">This action cannot be undone. This will permanently remove the <strong>@challenge.Name</strong> challenge.</p>
                </div>

                @* Details Card *@
                <div class="p-4 border border-dark bg-light mb-4 position-relative">
                    <dl class="row mb-0">
                        <dt class="col-sm-4 fd-label">NAME</dt>
                        <dd class="col-sm-8">@challenge.Name</dd>

                        <dt class="col-sm-4 fd-label">DETAILS</dt>
                        <dd class="col-sm-8">@challenge.Details</dd>

                        <div class="col-12"><hr class="text-muted" /></div>

                        <dt class="col-sm-4 fd-label">START DATE</dt>
                        <dd class="col-sm-8">@challenge.StartDate</dd>

                        <dt class="col-sm-4 fd-label">END DATE</dt>
                        <dd class="col-sm-8">@challenge.EndDate</dd>

                        <div class="col-12"><hr class="text-muted" /></div>

                        <dt class="col-sm-4 fd-label">DATE CREATED</dt>
                        <dd class="col-sm-8">@challenge.DateCreated</dd>

                        <dt class="col-sm-4 fd-label">DATE UPDATED</dt>
                        <dd class="col-sm-8">@challenge.DateUpdated</dd>

                        <dt class="col-sm-4 fd-label">CREATED BY</dt>
                        <dd class="col-sm-8">@challenge.CreatedBy</dd>

                        <dt class="col-sm-4 fd-label">UPDATED BY</dt>
                        <dd class="col-sm-8">@challenge.UpdatedBy</dd>
                    </dl>
                </div>

                @* Action Buttons *@
                <EditForm method="post" Model="challenge" OnValidSubmit="DeleteChallenge" FormName="delete" Enhance>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-danger fd-btn-delete px-4" disabled="@(challenge is null)">
                            CONFIRM DELETE
                        </button>
                        <a href="/challenges" class="btn fd-btn-outline-dark px-4">CANCEL</a>
                    </div>
                </EditForm>
            </div>
        </div>
    }
</div>

<style>
    :root {
        --fd-yellow: #F5EB3B;
        --fd-black: #222;
    }

    .fd-section-title {
        font-family: 'Arial Black', Gadget, sans-serif;
        font-weight: 900;
        letter-spacing: -1px;
        text-transform: uppercase;
    }

    .fd-label {
        font-weight: 900;
        font-size: 0.75rem;
        letter-spacing: 1px;
        color: #555;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
    }

    .fd-btn-delete {
        background: #dc3545;
        color: white;
        font-weight: 900;
        border: 2px solid var(--fd-black);
        border-radius: 0;
        transition: all 0.2s;
    }

        .fd-btn-delete:hover {
            background: var(--fd-black);
            color: white;
            border-color: var(--fd-black);
        }

    .fd-btn-outline-dark {
        border: 2px solid var(--fd-black);
        font-weight: 800;
        border-radius: 0;
        background: white;
        color: var(--fd-black);
        transition: all 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

        .fd-btn-outline-dark:hover {
            background: #eee;
            color: var(--fd-black);
        }
</style>

@code {
    private Challenge? challenge;

    [SupplyParameterFromQuery]
    private int Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        challenge = await context.Challenge.FirstOrDefaultAsync(m => m.Id == Id);

        if (challenge is null)
        {
            NavigationManager.NavigateTo("notfound");
        }
    }

    private async Task DeleteChallenge()
    {
        using var context = DbFactory.CreateDbContext();
        context.Challenge.Remove(challenge!);
        await context.SaveChangesAsync();
        NavigationManager.NavigateTo("/challenges");
    }
}