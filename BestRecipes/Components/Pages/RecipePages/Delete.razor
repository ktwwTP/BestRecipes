@page "/recipes/delete"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization @* 1. Add Authorization Namespace *@
@using BestRecipes.Domain
@inject IDbContextFactory<BestRecipes.Data.BestRecipesContext> DbFactory
@inject NavigationManager NavigationManager

@* 2. SECURITY LOCK: This prevents non-admins from accessing this page directly *@
@attribute [Authorize(Roles = "Administrator")]

<PageTitle>Delete Recipe</PageTitle>

<div class="container mt-4">
    <h1 class="fd-section-title text-start text-danger">DELETE RECIPE</h1>
    <hr style="border: 2px solid var(--fd-black); opacity: 1;" />

    @if (recipe is null)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-warning" role="status"></div>
            <p class="mt-2">Locating recipe...</p>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-md-6">
                <div class="alert alert-warning border-dark rounded-0 shadow-sm mb-4">
                    <h4 class="fw-bold"><i class="bi bi-exclamation-triangle"></i> Are you sure?</h4>
                    <p class="mb-0">This action cannot be undone. This will permanently remove <strong>@recipe.Title</strong>.</p>
                </div>

                <div class="p-4 border border-dark bg-light mb-4">
                    <dl class="row mb-0">
                        <dt class="col-sm-4 fd-label">TITLE</dt>
                        <dd class="col-sm-8">@recipe.Title</dd>

                        <dt class="col-sm-4 fd-label">CREATED BY</dt>
                        <dd class="col-sm-8">@recipe.CreatedBy</dd>

                        <dt class="col-sm-4 fd-label">DATE</dt>
                        <dd class="col-sm-8">@recipe.DateCreated.ToShortDateString()</dd>

                        @if (!string.IsNullOrEmpty(recipe.ImageUrl))
                        {
                            <dt class="col-sm-4 fd-label">PREVIEW</dt>
                            <dd class="col-sm-8">
                                <img src="@recipe.ImageUrl" class="img-thumbnail border-dark" style="max-height: 100px;" />
                            </dd>
                        }
                    </dl>
                </div>

                <EditForm method="post" Model="recipe" OnValidSubmit="DeleteRecipe" FormName="delete">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-danger fd-btn-delete px-4" disabled="@(recipe is null)">
                            CONFIRM DELETE
                        </button>
                        <a href="/recipes" class="btn fd-btn-outline-dark px-4">CANCEL</a>
                    </div>
                </EditForm>
            </div>
        </div>
    }
</div>

<style>
    :root {
        --fd-yellow: #F5EB3B;
        --fd-black: #222;
    }

    .fd-label {
        font-weight: 900;
        font-size: 0.75rem;
        letter-spacing: 1px;
        color: #555;
    }

    .fd-btn-delete {
        background: #dc3545;
        color: white;
        font-weight: 900;
        border: 2px solid var(--fd-black);
        border-radius: 0;
    }

        .fd-btn-delete:hover {
            background: var(--fd-black);
            color: white;
        }

    .fd-btn-outline-dark {
        border: 2px solid var(--fd-black);
        font-weight: 800;
        border-radius: 0;
        background: white;
        color: var(--fd-black);
    }

        .fd-btn-outline-dark:hover {
            background: #eee;
        }
</style>

@code {
    private Recipe? recipe;

    [SupplyParameterFromQuery]
    private int Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = await DbFactory.CreateDbContextAsync();
        // We fetch the recipe to show the user what they are about to delete
        recipe = await context.Recipe.FirstOrDefaultAsync(m => m.Id == Id);

        if (recipe is null)
        {
            NavigationManager.NavigateTo("/recipes");
        }
    }

    private async Task DeleteRecipe()
    {
        if (recipe != null)
        {
            using var context = await DbFactory.CreateDbContextAsync();

            // Note: If you want to delete the image file from the server as well,
            // you would add the System.IO.File.Delete logic here using recipe.ImageUrl.

            context.Recipe.Remove(recipe);
            await context.SaveChangesAsync();
            NavigationManager.NavigateTo("/recipes");
        }
    }
}