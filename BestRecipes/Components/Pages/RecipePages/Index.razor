@page "/recipes"
@using Microsoft.EntityFrameworkCore
@using BestRecipes.Domain
@using BestRecipes.Data
@inject IDbContextFactory<BestRecipesContext> DbFactory
@rendermode InteractiveServer

<PageTitle>Home | BestRecipes</PageTitle>

<div class="container mt-5">
    @* --- HEADER SECTION --- *@
    <div class="text-center mb-4">
        <div class="small fw-bold text-muted mb-2">HOME / RECIPES</div>
        <h1 class="display-4 fw-black m-0">POPULAR RECIPES</h1>
        <p class="text-muted">The community's most-loved dishes, all in one place.</p>
    </div>

    @* --- SEARCH & FILTER BAR --- *@
    <div class="row g-0 mb-5 align-items-stretch shadow-sm border border-dark">
        <div class="col-md-5 d-flex align-items-center bg-light border-end border-dark p-2">
            <i class="bi bi-search ms-2 me-2 text-muted"></i>
            <input type="text" class="form-control border-0 bg-transparent"
                   placeholder="What would you like to make?"
                   value="@SearchTerm"
                   @oninput="OnSearchInput" />
        </div>
        <div class="col-md-3 border-end border-dark">
            <select class="form-select border-0 h-100 fw-bold text-uppercase" @onchange="OnCategoryChange" style="border-radius:0;">
                <option value="0">All Categories</option>
                @if (categories != null)
                {
                    @foreach (var cat in categories)
                    {
                        <option value="@cat.Id">@cat.Name.ToUpper()</option>
                    }
                }
            </select>
        </div>
        <div class="col-md-4">
            <a href="recipes/create" class="btn btn-warning w-100 h-100 d-flex align-items-center justify-content-center fw-black border-0" style="border-radius:0; background-color: #F5EB3B;">
                + ADD A RECIPE
            </a>
        </div>
    </div>

    @* --- GRID SECTION (RESTORING THE CARDS) --- *@
    <div class="row g-4">
        @if (filteredRecipes == null)
        {
            <div class="text-center py-5"><div class="spinner-border text-warning"></div></div>
        }
        else if (!filteredRecipes.Any())
        {
            <div class="text-center py-5">
                <h3 class="fw-black">NO RECIPES FOUND</h3>
                <p class="text-muted">Try adjusting your search or category filter.</p>
                <button class="btn btn-dark fw-bold mt-2" @onclick="ResetFilters">CLEAR FILTERS</button>
            </div>
        }
        else
        {
            @foreach (var recipe in filteredRecipes)
            {
                <div class="col-md-6 col-lg-4">
                    @* --- FULL CARD START --- *@
                    <div class="card h-100 fd-recipe-card shadow-sm border-2 border-dark">

                        @* Image Container *@
                        <div class="fd-card-img-container">
                            <img src="@(string.IsNullOrEmpty(recipe.ImageUrl) ? "/images/placeholder.jpg" : recipe.ImageUrl)"
                                 class="card-img-top fd-card-img" alt="@recipe.Title">
                            <div class="fd-category-badge">@(recipe.Category?.Name?.ToUpper() ?? "RECIPE")</div>
                        </div>

                        @* Card Content *@
                        <div class="card-body d-flex flex-column p-4">
                            <h5 class="card-title fw-black mb-2">@recipe.Title.ToUpper()</h5>

                            <p class="card-text text-muted flex-grow-1 small" style="line-height: 1.5;">
                                @(recipe.Description?.Length > 90 ? recipe.Description.Substring(0, 87) + "..." : recipe.Description)
                            </p>

                            <div class="d-flex justify-content-between align-items-center mt-3 border-top border-dark pt-3">
                                <div class="small fw-black">
                                    <i class="bi bi-clock me-1"></i> @(recipe.PreparationTime + recipe.CookingDuration) MINS
                                </div>
                                <a href="recipes/details?id=@recipe.Id" class="btn btn-dark btn-sm fw-black px-4" style="border-radius: 0;">VIEW RECIPE</a>
                            </div>
                        </div>
                    </div>
                    @* --- FULL CARD END --- *@
                </div>
            }
        }
    </div>
</div>

<style>
    .fw-black {
        font-weight: 900;
    }

    .fd-recipe-card {
        transition: transform 0.2s ease-in-out;
        border-radius: 0;
        background: #fff;
    }

        .fd-recipe-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
        }

    .fd-card-img-container {
        position: relative;
        height: 220px;
        overflow: hidden;
        border-bottom: 2px solid #222;
    }

    .fd-card-img {
        height: 100%;
        width: 100%;
        object-fit: cover;
    }

    .fd-category-badge {
        position: absolute;
        top: 12px;
        left: 12px;
        background: #F5EB3B;
        color: #000;
        padding: 5px 15px;
        font-size: 0.75rem;
        font-weight: 900;
        letter-spacing: 1px;
        border: 1px solid #000;
    }
</style>

@code {
    private List<Recipe>? allRecipes;
    private List<Recipe>? filteredRecipes;
    private List<Category>? categories;

    private string SearchTerm { get; set; } = "";
    private int SelectedCategoryId { get; set; } = 0;

    protected override async Task OnInitializedAsync()
    {
        using var context = await DbFactory.CreateDbContextAsync();

        allRecipes = await context.Recipe
            .Include(r => r.Category)
            .OrderByDescending(r => r.DateCreated)
            .ToListAsync();

        categories = await context.Category.ToListAsync();

        filteredRecipes = allRecipes;
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        SearchTerm = e.Value?.ToString() ?? "";
        FilterRecipes();
    }

    private void OnCategoryChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
        {
            SelectedCategoryId = id;
            FilterRecipes();
        }
    }

    private void FilterRecipes()
    {
        if (allRecipes == null) return;

        filteredRecipes = allRecipes
            .Where(r =>
                (string.IsNullOrWhiteSpace(SearchTerm) ||
                 r.Title.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)) &&
                (SelectedCategoryId == 0 || r.CategoryId == SelectedCategoryId))
            .ToList();

        StateHasChanged();
    }

    private void ResetFilters()
    {
        SearchTerm = "";
        SelectedCategoryId = 0;
        filteredRecipes = allRecipes;
        StateHasChanged();
    }
}