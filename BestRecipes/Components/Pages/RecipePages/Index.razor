@page "/recipes"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using BestRecipes.Domain
@using BestRecipes.Data
@implements IAsyncDisposable
@inject IDbContextFactory<BestRecipes.Data.BestRecipesContext> DbFactory
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Recipes | Food.com Style</PageTitle>

<div class="recipes-page-header">
    <div class="container">
        <div class="fd-breadcrumb">HOME / RECIPES</div>

        @if (!string.IsNullOrWhiteSpace(SearchTerm))
        {
            <h1 class="fd-title">RESULTS FOR "@SearchTerm.ToUpper()"</h1>
            <p class="fd-subtitle">
                <a href="/recipes" class="text-decoration-none text-muted">CLEAR SEARCH</a>
            </p>
        }
        else
        {
            <h1 class="fd-title">POPULAR RECIPES</h1>
            <p class="fd-subtitle">The community's most-loved dishes, all in one place.</p>
        }
    </div>
</div>

<div class="search-filter-section sticky-top shadow-sm">
    <div class="container">
        <div class="row g-3 align-items-center">
            <div class="col-lg-6">
                <div class="search-box-large position-relative">
                    <span class="bi bi-search search-icon position-absolute" style="left: 15px; top: 15px;"></span>
                    @* 1. Updated binding to handle immediate typing updates *@
                    <input type="search"
                           @bind="SearchTerm"
                           @bind:event="oninput"
                           class="form-control fd-input ps-5"
                           placeholder="What would you like to make?" autofocus />
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <select @bind="selectedCategory" class="form-select fd-select">
                    <option value="0">ALL CATEGORIES</option>
                    @foreach (var category in categories)
                    {
                        <option value="@category.Id">@category.Name.ToUpper()</option>
                    }
                </select>
            </div>

            <div class="col-lg-3 col-md-6">
                <a href="recipes/create" class="btn fd-btn-primary w-100 text-decoration-none">
                    <span class="bi bi-plus-lg"></span> ADD A RECIPE
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container mt-5 mb-5">
    <div class="card border-0">
        <QuickGrid Class="table fd-table" Items="FilteredRecipes" Pagination="pagination">
            <PropertyColumn Property="recipe => recipe.Title" Sortable="true" Title="RECIPE NAME" Class="fd-column-title" />
            <PropertyColumn Property="recipe => recipe.PreparationTime" Sortable="true" Title="PREP" />
            <PropertyColumn Property="recipe => recipe.CookingDuration" Sortable="true" Title="COOK" />
            <PropertyColumn Property="recipe => recipe.ServingSize" Sortable="true" Title="SERVINGS" />
            <PropertyColumn Property="recipe => recipe.CreatedBy" Sortable="true" Title="AUTHOR" />

            <TemplateColumn Context="recipe" Title="ACTIONS">
                <div class="btn-group shadow-sm">
                    <a class="btn btn-sm fd-btn-outline" href="@($"recipes/edit?id={recipe.Id}")">EDIT</a>
                    <a class="btn btn-sm fd-btn-black" href="@($"recipes/details?id={recipe.Id}")">DETAILS</a>
                </div>
            </TemplateColumn>
        </QuickGrid>

        <div class="fd-paginator-wrapper">
            <Paginator State="@pagination" />
        </div>
    </div>
</div>

<style>
    :root {
        --fd-yellow: #F5EB3B;
        --fd-black: #222222;
        --fd-grey: #757575;
        --fd-light-grey: #F9F9F9;
    }

    .recipes-page-header {
        background-color: white;
        padding: 50px 20px 30px 20px;
        text-align: center;
        border-bottom: 1px solid #eee;
    }

    .fd-breadcrumb {
        font-size: 0.75rem;
        letter-spacing: 2px;
        color: var(--fd-grey);
        font-weight: 700;
        margin-bottom: 10px;
    }

    .fd-title {
        font-family: 'Arial Black', Gadget, sans-serif;
        font-size: 3.5rem;
        font-weight: 900;
        color: var(--fd-black);
        letter-spacing: -2px;
        margin-bottom: 5px;
    }

    .fd-subtitle {
        font-size: 1.1rem;
        color: var(--fd-grey);
    }

    .search-filter-section {
        background: white;
        padding: 15px 0;
        border-bottom: 2px solid var(--fd-black);
    }

    .fd-input {
        border: 2px solid var(--fd-black) !important;
        border-radius: 0 !important;
        font-weight: 700;
        height: 50px;
    }

    .fd-select {
        border: 2px solid var(--fd-black) !important;
        border-radius: 0 !important;
        font-weight: 700;
        height: 50px;
        text-transform: uppercase;
        cursor: pointer;
    }

    .fd-btn-primary {
        background-color: var(--fd-yellow);
        color: var(--fd-black);
        border: 2px solid var(--fd-black);
        border-radius: 0;
        font-weight: 900;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

        .fd-btn-primary:hover {
            background-color: var(--fd-black);
            color: var(--fd-yellow);
        }

    .fd-table {
        border-collapse: collapse;
        width: 100%;
    }

        .fd-table thead {
            background-color: var(--fd-yellow);
            color: black;
        }

            .fd-table thead th {
                font-weight: 900;
                font-size: 0.8rem;
                letter-spacing: 1px;
                padding: 15px !important;
                border: none;
                text-transform: uppercase;
            }

    .fd-column-title {
        font-weight: 800;
        color: var(--fd-black);
    }

    .fd-btn-outline {
        border: 1px solid var(--fd-black);
        color: var(--fd-black);
        font-weight: 700;
        border-radius: 0;
    }

    .fd-btn-black {
        background-color: var(--fd-black);
        color: white;
        font-weight: 700;
        border-radius: 0;
    }

        .fd-btn-black:hover {
            background-color: var(--fd-yellow);
            color: var(--fd-black);
        }

    .fd-paginator-wrapper {
        padding: 20px;
        display: flex;
        justify-content: center;
        background: var(--fd-light-grey);
    }

    .search-icon {
        z-index: 10;
        font-weight: bold;
        color: var(--fd-black);
    }
</style>

@code {
    [SupplyParameterFromQuery(Name = "search")]
    public string? SearchTerm { get; set; } // Nullable string to handle empty URL params safely

    private int selectedCategory = 0;
    private List<Category> categories = new();
    private PaginationState pagination = new PaginationState { ItemsPerPage = 10 };
    private BestRecipesContext context = default!;

    // 2. FIXED LOGIC: Only filter if SearchTerm actually has text
    private IQueryable<Recipe> FilteredRecipes
    {
        get
        {
            // Start with ALL recipes
            var query = context.Recipe.AsQueryable();

            // Only apply search filter if the user has typed something
            if (!string.IsNullOrWhiteSpace(SearchTerm))
            {
                query = query.Where(c => c.Title.Contains(SearchTerm));
            }

            // Apply category filter if one is selected
            if (selectedCategory != 0)
            {
                query = query.Where(r => r.CategoryId == selectedCategory);
            }

            return query;
        }
    }

    protected override void OnInitialized()
    {
        context = DbFactory.CreateDbContext();
        categories = context.Category.ToList();
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}