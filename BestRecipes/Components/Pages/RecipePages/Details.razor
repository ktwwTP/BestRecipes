@page "/recipes/details"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using BestRecipes.Domain
@inject IDbContextFactory<BestRecipes.Data.BestRecipesContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

@if (recipe is not null)
{
    <PageTitle>@recipe.Title - BestRecipes</PageTitle>

    @* --- HERO SECTION --- *@
    <div class="recipe-hero">
        <div class="container">
            <nav class="fd-breadcrumb">HOME / RECIPES / @recipe.Title.ToUpper()</nav>
            <h1 class="fd-recipe-title">@recipe.Title.ToUpper()</h1>

            <div class="fd-recipe-meta">
                <div class="meta-item">
                    <span class="bi bi-star-fill fd-yellow"></span>
                    <span class="bi bi-star-fill fd-yellow"></span>
                    <span class="bi bi-star-fill fd-yellow"></span>
                    <span class="bi bi-star-fill fd-yellow"></span>
                    <span class="bi bi-star fd-yellow"></span>
                    <span class="ms-2"><strong>4.5</strong> (12 REVIEWS)</span>
                </div>
                <div class="meta-item">
                    <i class="bi bi-person-circle"></i> BY <strong>@(recipe.CreatedBy?.ToUpper() ?? "CHEF")</strong>
                </div>
            </div>

            <div class="fd-action-bar mb-4">
                @* --- UPDATED SAVE BUTTON --- *@
                <button class="fd-btn-outline @(isFavourited ? "bg-dark text-white" : "")" @onclick="ToggleFavourite">
                    <i class="bi @(isFavourited ? "bi-heart-fill text-warning" : "bi-bookmark")"></i>
                    @(isFavourited ? "SAVED" : "SAVE")
                </button>

                <button class="fd-btn-outline"><i class="bi bi-printer"></i> PRINT</button>
                <a href="@($"/recipes/edit?id={recipe.Id}")" class="fd-btn-outline text-decoration-none"><i class="bi bi-pencil"></i> EDIT</a>
            </div>

            @if (!string.IsNullOrEmpty(recipe.ImageUrl))
            {
                <div class="recipe-image-container">
                    <img src="@recipe.ImageUrl" alt="@recipe.Title" class="img-fluid fd-hero-img" />
                </div>
            }
        </div>
    </div>

    @* --- MAIN CONTENT --- *@
    <div class="container mt-5">
        <div class="row">
            @* Left Column: Info and Ingredients *@
            <div class="col-lg-4">
                <div class="fd-sidebar-box">
                    <div class="fd-time-grid">
                        <div class="time-box">
                            <span class="label">PREP</span>
                            <span class="value">@DisplayPrepTime MIN</span>
                        </div>
                        <div class="time-box">
                            <span class="label">COOK</span>
                            <span class="value">@DisplayCookTime MIN</span>
                        </div>
                    </div>

                    <div class="fd-servings-box">
                        <span class="label">SERVINGS (YIELDS)</span>
                        <div class="servings-selector">
                            <button type="button" @onclick="() => AdjustServings(-1)">-</button>
                            <input type="number"
                                   @bind-value="currentServings"
                                   @bind-value:event="oninput"
                                   class="servings-input" />
                            <button type="button" @onclick="() => AdjustServings(1)">+</button>
                        </div>
                    </div>
                </div>

                <div class="fd-ingredients-section">
                    <h3 class="fd-section-header">INGREDIENTS</h3>
                    <ul class="fd-ingredient-list">
                        @if (recipe.RecipeIngredients != null && recipe.RecipeIngredients.Any())
                        {
                            @foreach (var ri in recipe.RecipeIngredients)
                            {
                                <li>
                                    <i class="bi bi-circle"></i>
                                    <div>
                                        <span class="fw-bold">@FormatQuantity(ri.Quantity)</span>
                                        @ri.Unit @ri.Ingredient?.Name
                                        @if (!string.IsNullOrEmpty(ri.Notes))
                                        {
                                            <span class="text-muted small"> (@ri.Notes)</span>
                                        }
                                    </div>
                                </li>
                            }
                        }
                        else
                        {
                            <li><i class="bi bi-circle"></i> No specific ingredients listed.</li>
                        }
                    </ul>
                </div>
            </div>

            @* Right Column: Instructions *@
            <div class="col-lg-8">
                <h3 class="fd-section-header">DIRECTIONS</h3>
                <div class="fd-instructions">
                    @{
                        var steps = recipe.Instructions?.Split(new[] { "\r\n", "\r", "\n" }, StringSplitOptions.RemoveEmptyEntries) ?? Array.Empty<string>();
                        int stepNum = 1;
                    }
                    @foreach (var step in steps)
                    {
                        <div class="fd-step">
                            <span class="step-number">@stepNum</span>
                            <p class="step-text">@step</p>
                        </div>
                        stepNum++;
                    }
                </div>

                <div class="fd-footer-meta mt-5">
                    <p><strong>RECIPE ID:</strong> @recipe.Id</p>
                    <p><strong>BASE SERVINGS:</strong> @baseServings</p>
                    <p><strong>PUBLISHED:</strong> @recipe.DateCreated.ToShortDateString()</p>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="container mt-5 text-center">
        <div class="spinner-border text-warning" role="status"></div>
        <p class="mt-2">Loading Deliciousness...</p>
    </div>
}

<style>
    :root {
        --fd-yellow: #F5EB3B;
        --fd-black: #222222;
        --fd-grey: #757575;
    }

    .recipe-hero {
        background-color: white;
        padding: 40px 0;
        border-bottom: 1px solid #eee;
    }

    .fd-breadcrumb {
        font-size: 0.75rem;
        letter-spacing: 2px;
        color: var(--fd-grey);
        margin-bottom: 15px;
        font-weight: 700;
    }

    .fd-recipe-title {
        font-family: 'Arial Black', sans-serif;
        font-size: 3.5rem;
        font-weight: 900;
        letter-spacing: -2px;
        color: var(--fd-black);
        margin-bottom: 20px;
    }

    .fd-recipe-meta {
        display: flex;
        gap: 30px;
        margin-bottom: 25px;
        font-size: 0.9rem;
        letter-spacing: 1px;
    }

    .fd-yellow {
        color: var(--fd-yellow);
        text-shadow: 1px 1px 1px #ccc;
    }

    .fd-btn-outline {
        background: white;
        border: 2px solid var(--fd-black);
        color: var(--fd-black);
        padding: 8px 20px;
        font-weight: 900;
        font-size: 0.8rem;
    }

        .fd-btn-outline:hover {
            background: var(--fd-black);
            color: white;
        }

    .fd-hero-img {
        width: 100%;
        max-height: 500px;
        object-fit: cover;
        border: 2px solid var(--fd-black);
    }

    .fd-section-header {
        font-family: 'Arial Black', sans-serif;
        font-weight: 900;
        border-bottom: 4px solid var(--fd-black);
        padding-bottom: 10px;
        margin-bottom: 20px;
        font-size: 1.5rem;
    }

    .fd-sidebar-box {
        background: #f9f9f9;
        padding: 20px;
        margin-bottom: 30px;
        border: 1px solid #ddd;
    }

    .fd-time-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 20px;
    }

    .time-box .label {
        font-size: 0.7rem;
        font-weight: 900;
        color: var(--fd-grey);
    }

    .time-box .value {
        font-weight: 900;
        font-size: 1.1rem;
    }

    .servings-input {
        width: 60px;
        border: none;
        background: transparent;
        text-align: center;
        font-weight: 900;
        font-size: 1.5rem;
        outline: none;
    }

    .fd-ingredient-list {
        list-style: none;
        padding: 0;
    }

        .fd-ingredient-list li {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 10px;
        }

    .fd-step {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
    }

    .step-number {
        background: var(--fd-black);
        color: white;
        min-width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 900;
    }

    .step-text {
        font-size: 1.1rem;
        line-height: 1.7;
        color: #333;
        margin: 0;
    }
</style>

@code {
    private Recipe? recipe;
    private int currentServings;
    private int baseServings;
    private bool isFavourited;
    private string? currentUserId;

    private decimal ScalingFactor => (baseServings > 0) ? (decimal)currentServings / baseServings : 1m;
    private int DisplayPrepTime => recipe != null ? (int)Math.Round(recipe.PreparationTime * (double)ScalingFactor) : 0;
    private int DisplayCookTime => recipe != null ? (int)Math.Round(recipe.CookingDuration * (double)ScalingFactor) : 0;

    [SupplyParameterFromQuery]
    private int Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = await DbFactory.CreateDbContextAsync();

        // --- IDENTITY USER CHECK ---
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity is not null && user.Identity.IsAuthenticated)
        {
            // Try different claim types to find the ID
            currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value 
                         ?? user.FindFirst("sub")?.Value; 
        }

        recipe = await context.Recipe
            .Include(r => r.RecipeIngredients)
            .ThenInclude(ri => ri.Ingredient)
            .FirstOrDefaultAsync(m => m.Id == Id);

        if (recipe is not null)
        {
            baseServings = recipe.ServingSize;
            currentServings = recipe.ServingSize;

            if (!string.IsNullOrEmpty(currentUserId))
            {
                // Compare using strings to avoid parsing errors here
                isFavourited = await context.Favourite
                    .AnyAsync(f => f.RecipeId == Id && f.UserId.ToString() == currentUserId);
            }
        }
        else
        {
            NavigationManager.NavigateTo("/recipes");
        }
    }

    private async Task ToggleFavourite()
    {
        // 1. Check if logged in
        if (string.IsNullOrEmpty(currentUserId))
        {
            NavigationManager.NavigateTo("Account/Login", forceLoad: true);
            return;
        }

        using var context = await DbFactory.CreateDbContextAsync();

        try 
        {
            // 2. Try to get the numeric ID safely
            // If your BestRecipesUser uses a string GUID for an ID, int.TryParse will return false
            if (!int.TryParse(currentUserId, out int numericId))
            {
                // If this triggers, your database uses string IDs, but your Favourite model uses int.
                // For now, let's assume it's a number.
                Console.WriteLine("ID Error: User ID is not a number.");
            }

            if (isFavourited)
            {
                var fav = await context.Favourite
                    .FirstOrDefaultAsync(f => f.RecipeId == Id && f.UserId == numericId);
                
                if (fav != null)
                {
                    context.Favourite.Remove(fav);
                }
            }
            else
            {
                context.Favourite.Add(new Favourite
                {
                    UserId = numericId,
                    RecipeId = Id,
                    Date = DateTime.Now,
                    CategoryId = recipe?.CategoryId ?? 0 // Required by your model
                });
            }

            await context.SaveChangesAsync();
            isFavourited = !isFavourited;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            // This will show up in your Visual Studio Output window
            Console.WriteLine($"DB Error: {ex.Message}");
        }
    }

    private void AdjustServings(int delta)
    {
        var nextValue = currentServings + delta;
        if (nextValue >= 1) currentServings = nextValue;
    }

    private string FormatQuantity(decimal quantity)
    {
        decimal scaledVal = quantity * ScalingFactor;
        double val = (double)scaledVal;
        if (val <= 0) return "";
        int wholeNumber = (int)val;
        double fraction = val - wholeNumber;
        string fractionText = fraction switch { >= 0.875 => "7/8", >= 0.75 => "3/4", >= 0.66 => "2/3", >= 0.5 => "1/2", >= 0.33 => "1/3", >= 0.25 => "1/4", >= 0.125 => "1/8", _ => "" };
        if (wholeNumber > 0 && !string.IsNullOrEmpty(fractionText)) return $"{wholeNumber} {fractionText}";
        if (!string.IsNullOrEmpty(fractionText)) return fractionText;
        return wholeNumber > 0 ? wholeNumber.ToString() : val.ToString("0.##");
    }
}