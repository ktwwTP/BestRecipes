@page "/recipes/trending"
@using BestRecipes.Domain
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<BestRecipes.Data.BestRecipesContext> DbFactory
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Trending Recipes | BestRecipes</PageTitle>

<div class="container mt-5 mb-5">
    @* --- HEADER SECTION --- *@
    <div class="text-center mb-5">
        <div class="small fw-bold text-muted mb-2">POPULAR RIGHT NOW</div>
        <h1 class="display-4 fw-black m-0">TRENDING RECIPES</h1>
        <p class="text-muted">Ranked by community favorites.</p>
        <div class="mx-auto mt-3" style="width: 100px; height: 4px; background: #000;"></div>
    </div>

    @if (trendingRecipes == null)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-warning" role="status"></div>
            <p class="mt-2 fw-bold">CALCULATING TRENDS...</p>
        </div>
    }
    else if (!trendingRecipes.Any())
    {
        <div class="text-center py-5">
            <h3 class="fw-black">NO TRENDING RECIPES YET</h3>
            <p class="text-muted">Recipes will appear here once they receive their first favorite!</p>
            <a href="/recipes" class="btn btn-dark fw-bold mt-2">BROWSE ALL RECIPES</a>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var item in trendingRecipes)
            {
                <div class="col-md-6 col-lg-3">
                    <div class="card h-100 fd-recipe-card shadow-sm border-2 border-dark"
                         style="cursor: pointer;"
                         @onclick="() => NavigateToRecipe(item.Recipe.Id)">

                        <div class="fd-card-img-container">
                            <img src="@(string.IsNullOrEmpty(item.Recipe.ImageUrl) ? "/images/placeholder.jpg" : item.Recipe.ImageUrl)"
                                 alt="@item.Recipe.Title" class="card-img-top fd-card-img" />

                            <div class="fd-category-badge">
                                <i class="bi bi-heart-fill me-1"></i> @item.FavCount FAVS
                            </div>
                        </div>

                        <div class="card-body d-flex flex-column p-3">
                            <h5 class="card-title fw-black mb-2" style="font-size: 1.1rem;">@item.Recipe.Title.ToUpper()</h5>
                            <p class="card-text text-muted flex-grow-1 small">
                                @(item.Recipe.Description?.Length > 70 ? item.Recipe.Description.Substring(0, 67) + "..." : item.Recipe.Description)
                            </p>

                            <div class="d-flex justify-content-between align-items-center mt-3 border-top border-dark pt-3">
                                <div class="small fw-black">
                                    <i class="bi bi-clock me-1"></i> @(item.Recipe.PreparationTime) MINS
                                </div>
                                <button class="btn btn-dark btn-sm fw-black px-3" style="border-radius: 0; font-size: 0.75rem;">
                                    VIEW RECIPE
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<RecipeCountDto>? trendingRecipes;

    protected override async Task OnInitializedAsync()
    {
        using var context = await DbFactory.CreateDbContextAsync();

        // The key logic: Count rows in Favourite table for each Recipe
        trendingRecipes = await context.Recipe
            .Select(r => new RecipeCountDto
            {
                Recipe = r,
                FavCount = context.Favourite.Count(f => f.RecipeId == r.Id)
            })
            // TESTING RULE: Only show if it has at least 1 favorite
            .Where(x => x.FavCount > 0)
            .OrderByDescending(x => x.FavCount)
            .Take(12)
            .ToListAsync();
    }

    public class RecipeCountDto
    {
        public Recipe Recipe { get; set; } = default!;
        public int FavCount { get; set; }
    }

    private void NavigateToRecipe(int id)
    {
        Navigation.NavigateTo($"/recipes/details?id={id}");
    }
}

<style>
    .fw-black {
        font-weight: 900;
    }

    .fd-recipe-card {
        transition: transform 0.2s ease-in-out;
        border-radius: 0;
        background: #fff;
    }

        .fd-recipe-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
        }

    .fd-card-img-container {
        position: relative;
        height: 180px;
        overflow: hidden;
        border-bottom: 2px solid #000;
    }

    .fd-card-img {
        height: 100%;
        width: 100%;
        object-fit: cover;
    }

    .fd-category-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: #F5EB3B;
        color: #000;
        padding: 4px 12px;
        font-size: 0.7rem;
        font-weight: 900;
        letter-spacing: 1px;
        border: 1px solid #000;
        z-index: 2;
    }
</style>