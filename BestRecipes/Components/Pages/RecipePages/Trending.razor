@page "/recipes/trending"
@using BestRecipes.Domain
@using Microsoft.EntityFrameworkCore
@inject BestRecipes.Data.BestRecipesContext DbContext
@inject NavigationManager Navigation

<div class="container mt-5">
    <div class="fd-header-box">
        <div class="fd-label">POPULAR RIGHT NOW</div>
        <h1 class="fd-section-title text-start">TRENDING RECIPES</h1>
        <p class="text-muted">Ranked by community favorites.</p>
    </div>

    @if (trendingRecipes == null)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-warning" role="status"></div>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var item in trendingRecipes)
            {
                <div class="col-md-4 col-lg-3">
                    <div class="recipe-card" @onclick="() => NavigateToRecipe(item.Recipe.Id)">
                        <div class="recipe-image-wrapper">
                            @* Uses ImageUrl if it exists, otherwise a placeholder *@
                            @* Change recipe.ImageUrl to item.Recipe.ImageUrl *@
                            <img src="@(string.IsNullOrEmpty(item.Recipe.ImageUrl) ? "https://picsum.photos/400/300?random=" + item.Recipe.Id : item.Recipe.ImageUrl)"
                                 alt="@item.Recipe.Title" class="recipe-img" />

                            @* Display the popularity badge *@
                            <div class="recipe-badge">
                                <i class="bi bi-heart-fill"></i> @item.FavCount FAVS
                            </div>
                        </div>
                        <div class="recipe-content">
                            <h3 class="recipe-title">@item.Recipe.Title.ToUpper()</h3>
                            <p class="recipe-description">@item.Recipe.Description</p>
                            <div class="recipe-meta">
                                <span><i class="bi bi-clock"></i> @item.Recipe.PreparationTime MINS</span>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<RecipeCountDto>? trendingRecipes;

    protected override async Task OnInitializedAsync()
    {
        // This query counts how many times each recipe appears in the 'Favourite' table
        trendingRecipes = await DbContext.Recipe
            .Select(r => new RecipeCountDto
            {
                Recipe = r,
                // We count the entries in the Favourite table where the RecipeId matches
                FavCount = DbContext.Favourite.Count(f => f.RecipeId == r.Id)
            })
            .OrderByDescending(x => x.FavCount) // Most favorites first
            .ThenByDescending(x => x.Recipe.Id)  // Then newest first
            .Take(12)
            .ToListAsync();
    }

    // This is a "Data Transfer Object" (DTO) to hold our combined data
    public class RecipeCountDto
    {
        public Recipe Recipe { get; set; } = default!;
        public int FavCount { get; set; }
    }

    private void NavigateToRecipe(int id)
    {
        Navigation.NavigateTo($"/recipes/details/{id}");
    }
}

@* KEEP YOUR EXISTING <style> BLOCK BELOW THIS *@

<style>
    .fd-header-box {
        border-bottom: 4px solid var(--fd-black);
        margin-bottom: 40px;
        padding-bottom: 20px;
    }

    .recipe-card {
        background: white;
        border: 2px solid var(--fd-black);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

        .recipe-card:hover {
            transform: translateY(-5px);
            box-shadow: 8px 8px 0px var(--fd-yellow);
        }

    .recipe-image-wrapper {
        position: relative;
        overflow: hidden;
        border-bottom: 2px solid var(--fd-black);
    }

    .recipe-img {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }

    .recipe-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: var(--fd-yellow);
        color: var(--fd-black);
        padding: 5px 10px;
        font-weight: 900;
        font-size: 0.7rem;
    }

    .recipe-content {
        padding: 20px;
    }

    .recipe-title {
        font-family: 'Arial Black', sans-serif;
        font-size: 1.1rem;
        margin-bottom: 10px;
        line-height: 1.2;
    }

    .recipe-description {
        font-size: 0.9rem;
        color: var(--fd-grey);
        margin-bottom: 15px;
    }

    .recipe-meta {
        font-weight: 700;
        font-size: 0.8rem;
        border-top: 1px solid #eee;
        padding-top: 10px;
    }
</style>