@page "/recipes/trending"
@using BestRecipes.Domain
@using Microsoft.EntityFrameworkCore
@inject BestRecipes.Data.BestRecipesContext DbContext
@inject NavigationManager Navigation
@* This line is required for buttons and interactions to work *@
@rendermode InteractiveServer

<PageTitle>Trending Recipes | BestRecipes</PageTitle>

<div class="container mt-5 mb-5">
    @* --- HEADER SECTION --- *@
    <div class="text-center mb-5">
        <div class="small fw-bold text-muted mb-2">POPULAR RIGHT NOW</div>
        <h1 class="display-4 fw-black m-0">TRENDING RECIPES</h1>
        <p class="text-muted">Ranked by community favorites.</p>
        <div class="mx-auto mt-3" style="width: 100px; height: 4px; background: #000;"></div>
    </div>

    @if (trendingRecipes == null)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-warning" role="status"></div>
            <p class="mt-2 fw-bold">CALCULATING TRENDS...</p>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var item in trendingRecipes)
            {
                <div class="col-md-6 col-lg-3">
                    @* Added @onclick to the whole card for better UX *@
                    <div class="card h-100 fd-recipe-card shadow-sm border-2 border-dark"
                         style="cursor: pointer;"
                         @onclick="() => NavigateToRecipe(item.Recipe.Id)">

                        @* Image Wrapper *@
                        <div class="fd-card-img-container">
                            <img src="@(string.IsNullOrEmpty(item.Recipe.ImageUrl)
                                                                          ? "/images/placeholder.jpg"
                                                                          : item.Recipe.ImageUrl)"
                                 alt="@item.Recipe.Title" class="card-img-top fd-card-img" />

                            <div class="fd-category-badge">
                                <i class="bi bi-heart-fill me-1"></i> @item.FavCount FAVS
                            </div>
                        </div>

                        @* Card Content *@
                        <div class="card-body d-flex flex-column p-3">
                            <h5 class="card-title fw-black mb-2" style="font-size: 1.1rem;">@item.Recipe.Title.ToUpper()</h5>

                            <p class="card-text text-muted flex-grow-1 small" style="line-height: 1.4;">
                                @(item.Recipe.Description?.Length > 70 ? item.Recipe.Description.Substring(0, 67) + "..." : item.Recipe.Description)
                            </p>

                            @* Footer with Time and Link *@
                            <div class="d-flex justify-content-between align-items-center mt-3 border-top border-dark pt-3">
                                <div class="small fw-black">
                                    <i class="bi bi-clock me-1"></i> @(item.Recipe.PreparationTime) MINS
                                </div>
                                @* Using a direct <a> tag is often more reliable for navigation *@
                                <a href="/recipes/details?id=@item.Recipe.Id"
                                   class="btn btn-dark btn-sm fw-black px-3"
                                   style="border-radius: 0; font-size: 0.75rem;"
                                   @onclick:stopPropagation>
                                    VIEW RECIPE
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<RecipeCountDto>? trendingRecipes;

    protected override async Task OnInitializedAsync()
    {
        // Fetching the most popular recipes based on Favourites table
        trendingRecipes = await DbContext.Recipe
            .Select(r => new RecipeCountDto
            {
                Recipe = r,
                FavCount = DbContext.Favourite.Count(f => f.RecipeId == r.Id)
            })
            .OrderByDescending(x => x.FavCount)
            .ThenByDescending(x => x.Recipe.Id)
            .Take(12)
            .ToListAsync();
    }

    public class RecipeCountDto
    {
        public Recipe Recipe { get; set; } = default!;
        public int FavCount { get; set; }
    }

    private void NavigateToRecipe(int id)
    {
        Navigation.NavigateTo($"/recipes/details?id={id}");
    }
}

<style>
    .fw-black {
        font-weight: 900;
    }

    .fd-recipe-card {
        transition: transform 0.2s ease-in-out;
        border-radius: 0;
        background: #fff;
    }

        .fd-recipe-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
        }

    .fd-card-img-container {
        position: relative;
        height: 180px;
        overflow: hidden;
        border-bottom: 2px solid #000;
    }

    .fd-card-img {
        height: 100%;
        width: 100%;
        object-fit: cover;
    }

    .fd-category-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: #F5EB3B;
        color: #000;
        padding: 4px 12px;
        font-size: 0.7rem;
        font-weight: 900;
        letter-spacing: 1px;
        border: 1px solid #000;
        z-index: 2;
    }
</style>