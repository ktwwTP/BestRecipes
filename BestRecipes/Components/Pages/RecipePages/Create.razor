@page "/recipes/create"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using BestRecipes.Domain
@using System.IO
@using Microsoft.AspNetCore.Hosting
@using System.Security.Claims
@inject IDbContextFactory<BestRecipes.Data.BestRecipesContext> DbFactory
@inject NavigationManager NavigationManager
@inject IWebHostEnvironment Environment
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS

<PageTitle>Create Recipe</PageTitle>

<div class="container mt-4">
    <h1 class="fd-section-title text-start">SHARE A RECIPE</h1>
    <hr style="border: 2px solid var(--fd-black); opacity: 1;" />

    <EditForm Model="Recipe" OnValidSubmit="AddRecipe" FormName="create">
        <DataAnnotationsValidator />
        <ValidationSummary class="text-danger" />

        <div class="row">
            @* Left Column: Basic Details *@
            <div class="col-md-5">
                <div class="mb-3">
                    <label class="fd-label">RECIPE TITLE</label>
                    <InputText @bind-Value="Recipe.Title" class="form-control fd-input" placeholder="e.g. Spicy Ramen" />
                    <ValidationMessage For="() => Recipe.Title" class="text-danger" />
                </div>

                <div class="mb-4 p-3 upload-box">
                    <label class="fd-label">UPLOAD PHOTO</label>
                    <InputFile OnChange="HandleFileSelected" class="form-control" />
                    @if (!string.IsNullOrEmpty(Recipe.ImageUrl))
                    {
                        <img src="@Recipe.ImageUrl" class="mt-2 preview-img" />
                    }
                    <small class="text-muted d-block mt-1">Max size: 5MB</small>
                </div>

                <div class="mb-3">
                    <label class="fd-label">DESCRIPTION</label>
                    <InputTextArea @bind-Value="Recipe.Description" class="form-control fd-input" rows="3" />
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="fd-label">PREP (MINS)</label>
                        <InputNumber @bind-Value="Recipe.PreparationTime" class="form-control fd-input" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="fd-label">COOK (MINS)</label>
                        <InputNumber @bind-Value="Recipe.CookingDuration" class="form-control fd-input" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="fd-label">SERVES</label>
                        <InputNumber @bind-Value="Recipe.ServingSize" class="form-control fd-input" />
                    </div>
                </div>

                <div class="mb-3">
                    <label class="fd-label">CATEGORY</label>
                    <InputSelect @bind-Value="Recipe.CategoryId" class="form-control fd-input">
                        <option value="">-- Select Category --</option>
                        @if (categories != null)
                        {
                            @foreach (var cat in categories)
                            {
                                <option value="@cat.Id">@cat.Name.ToUpper()</option>
                            }
                        }
                    </InputSelect>
                </div>
            </div>

            @* Right Column: Ingredients & Instructions *@
            <div class="col-md-7">
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="fd-label m-0">INGREDIENTS</label>
                        <button type="button" class="btn btn-link btn-sm p-0 text-dark fw-bold" @onclick="ShowIngredientModal">+ NEW INGREDIENT</button>
                    </div>

                    <div class="ingredient-container p-3">
                        @foreach (var ri in Recipe.RecipeIngredients)
                        {
                            <div class="row g-2 mb-2 align-items-center">
                                <div class="col-4">
                                    <InputSelect @bind-Value="ri.IngredientId" class="form-control fd-input-sm">
                                        <option value="0">Select...</option>
                                        @if (allIngredients != null)
                                        {
                                            @foreach (var ing in allIngredients)
                                            {
                                                <option value="@ing.Id">@ing.Name</option>
                                            }
                                        }
                                    </InputSelect>
                                </div>
                                <div class="col-3">
                                    <InputNumber @bind-Value="ri.Quantity" class="form-control fd-input-sm" step="0.01" placeholder="Qty" />
                                </div>
                                <div class="col-3">
                                    <InputSelect @bind-Value="ri.Unit" class="form-control fd-input-sm">
                                        <option value="">Unit...</option>
                                        @foreach (var unit in CommonUnits)
                                        {
                                            <option value="@unit">@unit</option>
                                        }
                                    </InputSelect>
                                </div>
                                <div class="col-2 text-end">
                                    <button type="button" class="btn btn-outline-danger btn-sm border-0" @onclick="() => RemoveIngredient(ri)">
                                        <i class="bi bi-x-lg">X</i>
                                    </button>
                                </div>
                            </div>
                        }
                        <button type="button" class="btn fd-btn-outline-dark btn-sm mt-2 w-100" @onclick="AddIngredientRow">
                            + ADD ANOTHER ROW
                        </button>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="fd-label">COOKING INSTRUCTIONS</label>
                    <InputTextArea @bind-Value="Recipe.Instructions" class="form-control fd-input" rows="8" placeholder="Step 1: Preheat oven..." />
                </div>

                <button type="submit" class="btn fd-btn-yellow w-100 py-3 mt-2">PUBLISH RECIPE</button>
            </div>
        </div>
    </EditForm>
</div>

@* Modal for Quick Adding Ingredients *@
@if (showModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.6); z-index: 1050;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 rounded-0 shadow-lg">
                <div class="modal-header bg-dark text-white rounded-0">
                    <h5 class="modal-title fw-bold">NEW INGREDIENT</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseIngredientModal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="fd-label">NAME</label>
                        <input type="text" @bind="newIng.Name" class="form-control fd-input" placeholder="e.g. Fresh Ginger" />
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary rounded-0" @onclick="CloseIngredientModal">CANCEL</button>
                    <button type="button" class="btn fd-btn-yellow rounded-0" @onclick="QuickSaveIngredient">SAVE</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    :root {
        --fd-yellow: #F5EB3B;
        --fd-black: #222;
    }

    .fd-label {
        font-weight: 900;
        font-size: 0.8rem;
        letter-spacing: 1px;
        color: black;
        display: block;
        margin-bottom: 5px;
    }

    .fd-input, .fd-input-sm {
        border: 2px solid var(--fd-black);
        border-radius: 0;
        padding: 10px;
    }

    .fd-input-sm {
        padding: 5px;
        font-size: 0.85rem;
    }

    .upload-box {
        background: #f8f9fa;
        border: 2px dashed #ccc;
    }

    .preview-img {
        max-height: 100px;
        border: 2px solid var(--fd-black);
    }

    .ingredient-container {
        border: 2px solid var(--fd-black);
        background: #fdfdfd;
    }

    .fd-btn-yellow {
        background: var(--fd-yellow);
        color: var(--fd-black);
        font-weight: 900;
        border: 2px solid var(--fd-black);
        border-radius: 0;
    }

        .fd-btn-yellow:hover {
            background: var(--fd-black);
            color: white;
        }

    .fd-btn-outline-dark {
        border: 2px solid var(--fd-black);
        font-weight: 800;
        border-radius: 0;
        background: white;
    }
</style>

@code {
    private Recipe Recipe { get; set; } = new() { RecipeIngredients = new List<RecipeIngredient>() };
    private Ingredient newIng = new() { Category = "General" };
    private List<Category>? categories;
    private List<Ingredient>? allIngredients;
    private bool showModal = false;
    private IBrowserFile? selectedFile;

    private readonly List<string> CommonUnits = new()
    { "Tsp", "Tbsp", "Cup", "ml", "L", "Gram", "Kg", "Pinch", "Whole", "Clove", "Can", "Packet" };

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        if (!Recipe.RecipeIngredients.Any()) AddIngredientRow();
    }

    private async Task LoadData()
    {
        using var context = await DbFactory.CreateDbContextAsync();
        categories = await context.Category.OrderBy(c => c.Name).ToListAsync();
        allIngredients = await context.Ingredient.OrderBy(i => i.Name).ToListAsync();
    }

    private void AddIngredientRow() => Recipe.RecipeIngredients.Add(new RecipeIngredient());
    private void RemoveIngredient(RecipeIngredient ri) => Recipe.RecipeIngredients.Remove(ri);
    private void ShowIngredientModal() { newIng = new Ingredient() { Category = "General" }; showModal = true; }
    private void CloseIngredientModal() => showModal = false;

    private async Task QuickSaveIngredient()
    {
        if (string.IsNullOrWhiteSpace(newIng.Name)) return;
        using var context = await DbFactory.CreateDbContextAsync();
        var existing = await context.Ingredient.FirstOrDefaultAsync(i => i.Name.ToLower() == newIng.Name.ToLower());
        if (existing == null)
        {
            context.Ingredient.Add(newIng);
            await context.SaveChangesAsync();
        }
        await LoadData();
        showModal = false;
    }

    private void HandleFileSelected(InputFileChangeEventArgs e) => selectedFile = e.File;

    private async Task AddRecipe()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            // 1. Handle Image Upload logic from version 1
            if (selectedFile != null)
            {
                var fileName = $"{Guid.NewGuid()}{Path.GetExtension(selectedFile.Name)}";
                var uploadsFolder = Path.Combine(Environment.WebRootPath, "uploads");
                if (!Directory.Exists(uploadsFolder)) Directory.CreateDirectory(uploadsFolder);

                var path = Path.Combine(uploadsFolder, fileName);
                using var stream = selectedFile.OpenReadStream(5120000);
                using var fileStream = new FileStream(path, FileMode.Create);
                await stream.CopyToAsync(fileStream);
                Recipe.ImageUrl = $"/uploads/{fileName}";
            }

            using var context = await DbFactory.CreateDbContextAsync();

            // 2. Set Metadata and User ID
            Recipe.DateCreated = DateTime.Now;
            Recipe.CreatedBy = user.Identity?.Name ?? "User";
            var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (int.TryParse(userIdClaim, out var userId)) Recipe.UserId = userId;

            // 3. Clean up empty ingredient rows before saving
            Recipe.RecipeIngredients = Recipe.RecipeIngredients
                .Where(ri => ri.IngredientId > 0)
                .ToList();

            context.Recipe.Add(Recipe);
            await context.SaveChangesAsync();

            NavigationManager.NavigateTo("/recipes/trending");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ERROR: {ex.Message}");
            await JS.InvokeVoidAsync("alert", "Error saving recipe: " + ex.Message);
        }
    }
}